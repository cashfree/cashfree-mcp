
  <!DOCTYPE html>
  <html>
    <head>
      <title>search.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="positive"><td class="">src/search.ts</td><td class="">99.21%</td><td class="">80%</td><td class="">127</td><td class="">126</td><td class="">1</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">/**
 * Provides search functionality for documentation using Trieve.
 * Exports functions to fetch search configuration and register the search tool.
 */

import axios, { AxiosResponse } from &quot;axios&quot;;
import { TrieveSDK } from &quot;trieve-ts-sdk&quot;;
import { z } from &quot;zod&quot;;
import { SUBDOMAIN, SERVER_URL } from &quot;./config.readonly.js&quot;;
import { formatErr, throwOnAxiosError } from &quot;./utils.js&quot;;
import { McpServer } from &quot;@modelcontextprotocol/sdk/server/mcp.js&quot;;
import { InitializationConfiguration } from &quot;./types.js&quot;;

const DEFAULT_BASE_URL = &quot;https://api.mintlifytrieve.com&quot;;

export async function fetchSearchConfigurationAndOpenApi(
  subdomain: string
): Promise&lt;InitializationConfiguration&gt; {
  try {
    const response: AxiosResponse&lt;InitializationConfiguration&gt; =
      await axios.get(`${SERVER_URL}/api/mcp/config/${subdomain}`, {
        validateStatus() {
          return true;
        },
      });
    throwOnAxiosError(response, &quot;Failed to fetch MCP config&quot;);
    return response.data;
  } catch (err) {
    throw new Error(
      formatErr(err).replace(
        &quot;Request failed with status code 404&quot;,
        `${subdomain} not found`
      )
    );
  }
}

interface TrieveChunk {
  chunk: {
    metadata: {
      title: string;
    };
    chunk_html: string;
    link: string;
  };
}

interface SearchResult {
  title: string;
  content: string;
  link: string;
}

async function search(
  query: string,
  config: InitializationConfiguration
): Promise&lt;SearchResult[]&gt; {
  const trieve = new TrieveSDK({
    apiKey: config.trieveApiKey,
    datasetId: config.trieveDatasetId,
    baseUrl: DEFAULT_BASE_URL,
  });

  const data = await trieve.autocomplete({
    page_size: 10,
    query,
    search_type: &quot;fulltext&quot;,
    extend_results: true,
    score_threshold: 1,
  });

  if (!data.chunks || data.chunks.length === 0) {
    throw new Error(&quot;No results found&quot;);
  }

  return data.chunks.map((result: TrieveChunk) =&gt; {
    const { chunk } = result;
    return {
      title: chunk.metadata.title,
      content: chunk.chunk_html,
      link: chunk.link,
    };
  });
}

export async function createSearchTool(server: McpServer): Promise&lt;void&gt; {
  const config = await fetchSearchConfigurationAndOpenApi(SUBDOMAIN);

  server.tool(
    &quot;search&quot;,
    `Search across the ${config.name} documentation to fetch relevant context for a given query`,
    { query: z.string() },
    async ({ query }: { query: string }) =&gt; {
      const results = await search(query, config);

      const content = results.map((result: SearchResult) =&gt; {
        const { title, content, link } = result;
        const text = `Title: ${title}\nContent: ${content}\nLink: ${link}`;
        return {
          type: &quot;text&quot; as const,
          text,
        };
      });

      return { content };
    }
  );
}
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;src/search.ts&quot;,&quot;line&quot;:29,&quot;character&quot;:21,&quot;text&quot;:&quot;replace&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 22 May 2025 12:43:43 GMT</p>
    </body>
  </html>
  